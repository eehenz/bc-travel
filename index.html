<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>BC Travel - Bookings</title>
  <style>
    table {
      border: 2px;
      font-family: Arial, Helvetica, sans-serif;
      font-size: 10pt;
    }
    th {
      background-color: peru;
      text-align: left;
      padding: 4pt;
    }
    tr:nth-child(odd) {
      background-color: peachpuff;
    }
    tr:nth-child(even) {
      background-color: papayawhip;
    }
    tr.archived {
      background-color: LightGray;
      color: DarkGray;
    }
    td {
      text-align: left;
      padding: 4pt;            
    }
  </style>
  <script src="https://code.jquery.com/jquery-3.4.1.js"></script>
</head>

<body>

<div id="content">
  <table id="bookings">
    <thead>
      <th>Trip</th>
      <th>Date</th>
      <th>Ticket</th>
      <th>Dep Station</th>
      <th>Dep Time</th>
      <th>Arr Station</th>
      <th>Arr Time</th>
      <th>Train</th>
      <th>Duration</th>
      <th>Seat</th>
      <th>Gate</th>
      <th>Booking Date</th>                              
    </thead>
    <tbody id="bookings-body"></tbody>
  </table>
</div>


<script>

var dayNameMap = { 
  "monday": "周一", 
  "tuesday": "周二", 
  "wednesday": "周三",
  "thursday": "周四",
  "friday": "周五",
  "saturday": "周六",
  "sunday": "周日"
};        

var stationMap = {
  "changzhou": "常州",
  "changzhoubei": "常州北",
  "hangzhoudong": "杭州东",
  "hefeinan": "合肥南",
  "nanjingnan": "南京南",
  "ningbo": "宁波",
  "shanghaihongqiao": "上海虹桥",  
  "suzhou": "苏州",
  "suzhoubei": "苏州北",  
  "zhenjiangnan": "镇江南",
  "wenzhounan": "温州南"
  // TODO: Changzhou
  // TODO: Wenzhou
  // TODO: Wuxi
};

(function() {
  $.getJSON("https://eehenz.github.io/bc-travel/train-bookings.json", function(data) {
  //$.getJSON("./train-bookings.json", function(data) {
    $.each( data, function( key, value ) {      
      var detailInfo = value['DetailInfo'];

      var ticketInfo = detailInfo['orderDetailCard'];      
      var ticketBookingDateParts = ticketInfo['bookDate'].split("-");      
      var ticketBookingDate = String(Number(ticketBookingDateParts[2]) - 2000) + "-" + ticketBookingDateParts[1] + "-" + ticketBookingDateParts[0];
      //var ticketBookingDate = String(Number(ticketBookingDateParts[2]) - 2000) + ticketInfo[1] + ticketBookingDateParts;
      var ticketPickupNumber = ticketInfo['electronicOrderNo'];

      var trainInfo = detailInfo['trainInfos'][0];
      var trainDuration = String(trainInfo['duration']).replace("h", "小时").replace("m", "分");
      var trainNumber = trainInfo['trainNO'];
      var trainSeatType = trainInfo['seatType'];

      var passenger = trainInfo['passengers'][0];
      var passengerName = passenger[0];
      var passengerSeatParts = passenger[3].split(" ");
      var passengerSeat = passengerSeatParts[1] + "车" + passengerSeatParts[3] + "号";
      var passengerGate = passenger[6];

      var departureInfo = trainInfo['departureInfo'];
      var departureStation = translateStation(departureInfo[0]);
      var departureTime = departureInfo[1];
      //var departureDate = ;
      
      var departureDateParts = String(departureInfo[2]).split(" ");
      var departureDate = departureDateParts[0];
      var departureDayName = translateDayName(departureDateParts[1]);

      var arrivalInfo = trainInfo['arrivalInfo'];      
      var arrivalStation = translateStation(arrivalInfo[0]);
      var arrivalTime = arrivalInfo[1];
      var arrivalDate = arrivalInfo[2];

      key = key.trim().toUpperCase()
      var isArchivedBooking = key.startsWith("X");
      key = key.replace("X", "")
      key = key.trim()

      var rowHTML = "";
      rowHTML += "<tr lump " + (isArchivedBooking ? " class='archived'" : "") + ">";
      rowHTML   += "<td>" + key + "</td>";
      rowHTML   += "<td>" + departureDate + " " + departureDayName + "</td>";
      rowHTML   += "<td>" + ticketPickupNumber + "</td>"; 
      rowHTML   += "<td>" + departureStation + "</td>";         
      rowHTML   += "<td>" + departureTime + "</td>";        
      rowHTML   += "<td>" + arrivalStation + "</td>";            
      rowHTML   += "<td>" + arrivalTime + "</td>";
      rowHTML   += "<td>";
      if (!isArchivedBooking) {
        rowHTML   +=    "<a href='http://shike.gaotie.cn/checi.asp?checi=" + trainNumber + "' target='_blank'>" + trainNumber + "</a>";
      } else {
        rowHTML   +=    trainNumber;
      }
      rowHTML   += "</td>";
      rowHTML   += "<td>" + trainDuration + "</td>";
      rowHTML   += "<td>" + passengerSeat + "</td>";           
      rowHTML   += "<td>" + passengerGate + "</td>";           
      rowHTML   += "<td>" + ticketBookingDate + "</td>";
      rowHTML += "</tr>";

      $( rowHTML ).appendTo( "#bookings-body" );
    });
  });
})();

function translateDayName(dayName) {
  var lowerCaseDayName = String(dayName).toLowerCase();
  console.log(lowerCaseDayName);
  if ( Object.keys(dayNameMap).includes( lowerCaseDayName ) ) {
    return dayNameMap[lowerCaseDayName];
  }
  return dayName;
}

function translateStation(station) {
  var lowerCaseStation = String(station).toLowerCase();
  console.log(lowerCaseStation);
  if ( Object.keys(stationMap).includes( lowerCaseStation ) ) {
    return stationMap[lowerCaseStation];
  }
  return station;
}

</script>

</body>
</html>